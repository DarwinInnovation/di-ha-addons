#!/usr/bin/with-contenv bashio
# ==============================================================================
# Start the example service
# s6-overlay docs: https://github.com/just-containers/s6-overlay
# ==============================================================================

## Load env vars
export SWITCHBOT_TOKEN=$(bashio::config 'switchbot.token')
export SWITCHBOT_SECRET=$(bashio::config 'switchbot.secret')

if bashio::config.has_value 'mqtt.host'; then
  export MQTT_HOST=$(bashio::config 'mqtt.host')
  bashio::log.info "Using MQTT host from add-on configuration"
else
  export MQTT_HOST=$(bashio::services mqtt "host")
fi

if bashio::config.has_value 'mqtt.username'; then
  export MQTT_USER=$(bashio::config 'mqtt.username')
else
  export MQTT_USER=$(bashio::services mqtt "username")
fi

if bashio::config.has_value 'mqtt.password'; then
  export MQTT_PASSWORD=$(bashio::config 'mqtt.password')
else
  export MQTT_PASSWORD=$(bashio::services mqtt "password")
fi

if ! bashio::var.has_value "$MQTT_HOST"; then
  bashio::log.fatal "MQTT host is not configured; set mqtt.host or provide the MQTT service"
  exit 1
fi

## Run your program
bashio::log.info "Running switchbot-mqtt-proxy.py"
exec /usr/bin/switchbot-mqtt-proxy.py
bashio::log.info "Ran switchbot-mqtt-proxy.py"